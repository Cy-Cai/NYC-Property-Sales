---
title: "New York City Property Sale Price Prediction"
author: "Cyrus Cai"
date: "5/16/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if(!require(broom)) install.packages("broom", repos = "http://cran.us.r-project.org")
if(!require(graphics)) install.packages("graphics", repos = "http://cran.us.r-project.org")
if(!require(UsingR)) install.packages("UsingR", repos = "http://cran.us.r-project.org")
if(!require(forcats)) install.packages("forcats", repos = "http://cran.us.r-project.org")

if(!require(tidyverse)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")
if(!require(tinytex)) install.packages("tinytex", repos = "http://cran.us.r-project.org")
if(!require(dplyr)) install.packages("dplyr", repos = "http://cran.us.r-project.org")

library(broom)
library(graphics)
library(UsingR)
library(forcats)
library(dplyr)
library(tidyverse)
library(tinytex)
load("rda/train_set.rda")
load("rda/test_set.rda")
```

# 1 Introduction
With the assumption that historical data contains inights for the future, we attempt to predict human behavior. The research is done in various areas, such as retail, movies, polls etc. 

## 1.1 The Chanllenge 
In this project, I will build a regression model for property sale. The model will predict the sale price for an exsiting property in New York City. I will only look at the properties which is between 50 thousand and 5 millions and is one family dwelling.

## 1.2 Dataset: Properties Sold in New York City 
I will use **nyc-rolling-sales** as my dataset. The data set is generated by New York City Department of Finance. You can find and download the daata through the link [https://www.kaggle.com/new-york-city/nyc-property-sales].  

```{r NYC Properties head,echo=FALSE}
head(train_set,5)
```

## 1.3 Goal
I will find a consice and yet accurate model. The project is aimed at adjusted R square of 50% and RMSE of 10K. The project is also aimed to produce an easy-to-follow and reproducible report.


# 2 Analysis
Before modeling, I create two dataset: **edx** and **validation**. The **validation** is 10% of the full dataset, and is only used for final assessement of the model. It won't be used for anywhere else in the project. The **edx** data is going to be split into two subset, **train_set** and **test_set**.

## 2.1 The Simplest Model
The simplest model, {Sale Price}=b0+b1*{Gross Square Feet}+e_i.I only consider the gross square feet in this model. 

```{r, echo=FALSE}
RMSE <- function(true_price,predicted_price){
  sqrt(mean((true_price-predicted_price)^2))
}
```

```{r}
fit_simplest<- lm(SALE.PRICE~GROSS.SQUARE.FEET,data = train_set)

tidy(fit_simplest)
summary(fit_simplest)[9]
```


### Performance

```{r, echo=FALSE}
b0<-fit_simplest$coefficients[1]
b1<-fit_simplest$coefficients[2]

newd<-data.frame(GROSS.SQUARE.FEET=test_set$GROSS.SQUARE.FEET)
predicted_price<- predict(fit_simplest,newd,interval="prediction")
rmse_simplist_model<-RMSE(test_set$SALE.PRICE,predicted_price[,1])  
temp_p<-test_set %>%mutate(predicted_price=b0+b1*GROSS.SQUARE.FEET) %>% 
    mutate(residul=(SALE.PRICE-predicted_price)^2) %>%  group_by(Prop_ID) %>%
    summarise(r=sqrt(mean(residul)))
MED<-median(temp_p$r)

rmse_results <- data.frame(method="gross sq ft",RMSE_in_thousand=round(rmse_simplist_model/1000,0),Median_Residual_in_thousand=round(median(temp_p$r)/1000,0))%>%
    mutate(k=round(RMSE_in_thousand/Median_Residual_in_thousand,0),Adj_r_sq=summary(fit_simplest)[9])

```
```{r}
rmse_results 
```

### Pros
This modle is the simplest linear regression model.

### Cons
The adjusted r square is only 28%. And the RMSE for the properties in Manhattan (Borough 1) is very high.

```{r,echo=FALSE}
temp_p<-test_set %>%mutate(predicted_price=b0+b1*GROSS.SQUARE.FEET) %>% 
    mutate(residul=(SALE.PRICE-predicted_price)^2)

loop.names<-names(temp_p)
i=2

temp_p%>%dplyr::select(i,26) %>%
     rename(A=1) %>%
        group_by(A) %>%
    summarise(r=sqrt(mean(residul)),n=NROW(A))%>%
        ggplot(aes(A,r,fill=n))+geom_bar(stat = "identity") +
       labs(x=loop.names[i],y="Residual")+scale_fill_gradient(low="blue", high="red")+
      geom_text(aes(label=round(r,3)),size=3,check_overlap = TRUE,position=position_dodge(width=0.9), vjust=-0.25)+theme(axis.text.x = element_text(angle = 90, hjust = 1))+
     geom_hline(yintercept=rmse_simplist_model)

```

Therefore, I need to consider borough as a factor for the next model.


## 2.2 Model 2
In the 2nd Model,I consider GROSS.SQUARE.FEET as well as whethr the property is in Manhattan.The regression expression is y=b0+b1*GSF+b2*(I(Manhattan)*GSF.


### Performance


### Pros

### Cons


## 2.3 Model 3


### Performance


### Pros

### Cons


# 3 Results

## Model Summary

# 4 Conclusion

## Summary of the report


## Limitations

## Future Works

# 5 Reference
